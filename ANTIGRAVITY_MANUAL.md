# Antigravity 運用マニュアル

このリポジトリには、開発を「最高速度」かつ「最高品質」で進めるための自律型エージェント設定 (Antigravity) が組み込まれています。

---

## 🧭 クイック・ナビゲーション (Quick Navigation)

### 👤 あなたの役割は？ (Role-Based View)
- **PM / 企画者**: アイデアを仕様に落とすなら → [要件定義 (`@[/spec-phase]`)](#2-要件)
- **エンジニア**: コードを書く・直すなら → [実装 (`@[/impl]`)](#4-実装) / [設計 (`@[/design]`)](#3-設計)
- **レビューア**: 品質をチェックするなら → [出荷監査 (`@[/ship]`)](#5-出荷) / [厳格監査 (`@[/audit]`)](#tool-audit)

### ⚡ 超速見表 (The Cheat Sheet)
「今やりたいこと」からコマンドを選んでください。

| 今の状態 | やりたいこと | 魔法のコマンド |
| :--- | :--- | :--- |
| 🆕 **新規** | 「こんな機能ほしいな...」 | `@[/spec-phase]` |
| 🔨 **開発** | 「仕様は決まった！作るぞ！」 | `@[/design]` |
| 🐛 **バグ** | 「動かない！直して！」 | `@[/impl]` |
| 🧹 **改善** | 「コードを綺麗にしたい」 | `@[/refactor]` |
| 🚢 **出荷** | 「完璧？リリースしていい？」 | `@[/ship]` |
| 🛡️ **監査** | 「セキュリティ大丈夫？」 | `@[/audit]` |
| ❓ **迷子** | 「次なにするんだっけ？」 | `@[/onboard]` |
| 🔚 **終了** | 「作業完了！解散！」 | `@[/wrap-up]` |
| 🆘 **救助** | 「助けてドラ○もん！」 | `@[/help]` |

---

## 🚀 基本サイクル (The Golden Cycle)

開発は以下のサイクルで回してください。**全てのフェーズに専用コマンドがあります。**

```mermaid
graph LR
    Start(開始/復帰) --> Spec(要件定義)
    Spec --> Design(設計)
    Design --> Impl(実装)
    Impl --> Ship(出荷監査)
    Ship --> WrapUp(終了/保存)
```

| フェーズ          | コマンド           | やること                                                                     |
| :---------------- | :----------------- | :--------------------------------------------------------------------------- |
| **1. 開始** | `@[/onboard]`    | 現状把握。「前回何したっけ？次は？」を教えてくれる。                         |
| **2. 要件** | `@[/spec-phase]` | 何を作るか決める。「これ提案して」と言えば全部書いてくれる。                 |
| **3. 設計** | `@[/design]`     | **最重要**。DB/API/構成図を作る。「全部提案して」でOK。                |
| **4. 実装** | `@[/impl]`       | 設計書通りにコーディング。タスク分解して一気に作る。                         |
| **5. 出荷** | `@[/ship]`       | **最終関門**。テスト・レビュー・セキュリティ・性能・品質を全チェック。 |
| **6. 終了** | `@[/wrap-up]`    | **記憶の保存**。作業ログを残してチャットを綺麗に閉じる。                     |

---

## 🛡️ Security Profiles & Optimization (V2)

プロジェクトの規模に応じて、最適な「守り」と「速さ」を自動調整します。

### 1. Security Profiles (L1-L4)
`@[/config]` または `.agent/config.json` で設定します。
- **L1 (Startup)**: MVP向け。認証と個人情報保護のみ。
- **L2 (Standard)**: SaaS標準。**推奨**。
- **L3 (Enterprise)**: 金融/医療グレード。10層の防御を全適用。
- **L4 (National)**: 国家機密/防衛グレード。Air-Gap必須。

### 2. Deep Optimization (高速化)
- **Smart Testing**: 開発中(`impl`)は、変更に関連するテストのみを数秒で実行します。
- **Safety Net**: 出荷時(`ship`)は、強制的に全テストを実行し、安全性を担保します。
- **Silent Protocol**: Turbo Mode中はAIの口数を減らし、トークン消費を抑えます。

---

## 🛠️ 便利コマンド (Utility)

困ったときや、既存コードを直したいときはこれを使います。

- **`@[/help]` (AI Concierge)**: **迷ったらこれ**。状況に合わせて「次に打つべきコマンド」を1つだけ提案してくれます。
- **`@[/config]` (設定変更)**: セキュリティレベル(L1-L4)を確認・変更します。
- **`@[/consult]` (コンサル)**: 「もっと良くするには？」を能動的に提案してもらう。既存PJの診断に最適。
- **`@[/refactor]` (安全な掃除)**: 「壊さずに綺麗にする」。テスト→修正→テストを自動で行う。動作が変わったらロールバックされる。
- **`@[/sec]` (セキュリティ)**: 脆弱性やインフラ設定の監査だけを単独で行う。
- **`@[/audit]` (厳格監査)**: セキュリティと品質の徹底的な監査を行う。**物理レポートも生成します**。
- **`@[/wrap-up]` (作業終了)**: **「未来の自分への引継ぎ書」** を作成し、記憶を圧縮保存して終了します。
- **`@[/test]` (高速テスト)**: **Smart Testing** により、関連するテストのみを高速実行します。

---

## 💬 コピペで使えるチャットテンプレート

AIへの指示に迷ったら、以下をコピーして使ってください。

### ケース1: 新機能を作りたいとき

```markdown
@[/spec-phase]
# 新機能の要望
現在作成中のアプリに「タスク管理機能」を追加したいです。
ユーザーがタスクを追加・編集・削除できるようにしたい。
詳細な要件や非機能要件は、一般的なWebアプリの構成で**全て提案してください**。
```

### ケース2: バグを直したいとき

```markdown
@[/impl]
# バグ修正依頼
以下の事象が発生しているので、原因を調査して修正してください。
- 事象: ログイン画面で「送信」を押しても反応がない。
- 期待値: ダッシュボードに遷移すること。
※ 修正前に必ず原因の仮説を立てて説明してください。
```

### ケース3: 既存コードを綺麗にしたいとき

```markdown
@[/refactor]
対象: src/features/auth/AuthService.ts

上記のファイルが300行を超えて読みづらいです。
機能は一切変えずに、可読性を上げるためにリファクタリングしてください。
ロジックの分離や関数の抽出を行ってください。
```

### ケース4: 途中から参画したプロジェクトで現状を知りたいとき

```markdown
@[/consult]
このプロジェクトに初めて参画しました。
コードの品質、ディレクトリ構成の問題点、セキュリティリスクなど、
改善すべき点を**辛口で**リストアップしてください。
```

### ケース5: とにかくリリースしていいか不安なとき

```markdown
@[/ship]
実装が終わりました。
リリースしても大丈夫か、全ての監査（テスト・セキュリティ・パフォーマンス・品質）を実行してください。
エラーが出たら、修正案もセットで提示してください。
```

---

## 🔄 複数チャットでの運用技 (Micro-Context Strategy)

会話が長くなるとAIの動作が重くなり、精度が落ちます。
**「1つの機能＝1つのチャット」** と考え、以下のフローで切り替えるのが「最強の最適化」です。

1. **作業完了**: ある機能の実装が終わる。
2. **記憶の保存**: `@[/wrap-up]` を実行する。
   - これで現在の状態が `task.md` に保存され、安心してチャットを閉じられます。
3. **リセット**: **「新しいチャット」** を開く。
4. **記憶の復元**: `@[/onboard]` を実行する。
   - これで「重たいチャット履歴」は消え、「最新の成果物」だけが脳に入った状態でスタートできます。

---

## ⚠️ 絶対に守るべきルール

1. **迷ったら `@[/design]`**: いきなりコードを書かせない。必ず設計図（地図）を作らせる。
2. **監査は `@[/ship]`**: 人間の目でチェックする前に、まずAIの監査を通す。
3. **対話は日本語**: 思考の解像度を上げるため、常に日本語でやり取りする。

---

## 🌳 Git運用のベストプラクティス

チーム開発を円滑にするためのGit運用ルールです。

### 1. ブランチの切り方

```bash
# 新機能を作るとき
git switch -c feature/add-login-form

# バグを直すとき
git switch -c fix/login-error

# 綺麗にするとき
git switch -c refactor/auth-service
```

### 2. コミットメッセージの型 (Conventional Commits)

```bash
git commit -m "feat: ログイン画面のUI実装"
git commit -m "fix: パスワード入力欄のバグ修正"
git commit -m "docs: API設計書の更新"
git commit -m "style: インデント修正（ロジック変更なし）"
git commit -m "refactor: 認証ロジックの共通化"
```

### 3. マージの心得 (Squash Merge)

履歴を綺麗に保つため、機能ブランチをマージするときは「Squash Merge（1つにまとめる）」を推奨します。
AIが過去の修正を読み解く際、細かい `wip` コミットが大量にあると混乱するためです。

### 4. お掃除コマンド (Cleanup)

「ブランチが増えすぎて見づらい」を防ぐため、マージ済みのブランチは定期的に一括削除しましょう。

```bash
# マージ済みブランチをローカルから一掃する
git fetch -p && git branch --merged main | grep -v main | xargs git branch -d
```

GitHubの設定で **"Automatically delete head branches"** をONにしておくと、リモートも勝手に綺麗になります。

---

## 👑 Expert Prompt Library (参謀への相談)

上級者向けの「目的別・深掘りプロンプト」です。
AIを「作業員」ではなく「技術顧問」として使う場合にコピペして利用してください。

### 1. Deep Consult (技術相談)

#### アーキテクチャ診断
```markdown
@[/consult]
# アーキテクチャ診断依頼
現在の `src` ディレクトリの構成を分析してください。
- 将来的にスケーラビリティの問題になりそうな箇所は？
- 循環参照や密結合のリスクは？
辛口で指摘し、理想的な構成案をツリー形式で提示してください。
```

#### セキュリティ「赤チーム」演習
```markdown
@[/consult]
# 脆弱性診断 (Red Team)
あなたは攻撃者です。現在のコードベース (`.`) から、侵入可能な穴を探してください。
- SQLi, XSS, CSRF
- 認可不備 (IDOR)
- 秘密情報の露出
攻撃シナリオと、それを防ぐための `defense.md` に基づく修正案を提示してください。
```

### 2. Tactical Refactor (外科手術)

#### DRY原則の適用
```markdown
@[/refactor]
対象: [ディレクトリパス]
指示: 似たようなロジックが散乱しています。
共通関数またはHookとして抽出し、DRY (Don't Repeat Yourself) 原則を徹底してください。
```

#### モダン化 (Legacy to Modern)
```markdown
@[/refactor]
対象: [ファイルパス]
指示: この古い実装パターン（例: Class Component, Callback Hell）を、
最新のモダンな書き方（Hooks, Async/Await）にリプレイスしてください。
```

#### パフォーマンス・チューニング
```markdown
@[/refactor]
対象: [重いコンポーネント]
指示: 無駄な再レンダリングや計算が発生している可能性が高いです。
`useMemo`, `useCallback` の適用や、計算量の削減を行ってください。
```

---
